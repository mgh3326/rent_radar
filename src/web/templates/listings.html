{% extends "base.html" %}

{% block title %}ë§¤ë¬¼ ëª©ë¡ - Rent Radar{% endblock %}

{% block content %}
<div class="container">
    <h1>ğŸ  ë§¤ë¬¼ ëª©ë¡</h1>

    <form action="/web/listings" method="get" class="filters">
        <div>
            <label>ì§€ì—­:</label>
            <select name="region_code">
                <option value="">ì „ì²´</option>
                {% for sido, districts in sido_sigungu.items() %}
                    <optgroup label="{{ sido }}">
                        {% for code, name in districts %}
                            <option value="{{ code }}" {% if filters.region_code == code %}selected{% endif %}>
                                {{ name }}
                            </option>
                        {% endfor %}
                    </optgroup>
                {% endfor %}
            </select>
        </div>
        <div>
            <label>ë™:</label>
            <input type="text" name="dong" value="{{ filters.dong }}" placeholder="ì˜ˆ: ì‚¬ì§ë™">
        </div>
        <div>
            <label>ë§¤ë¬¼ìœ í˜•:</label>
            <select name="property_type">
                <option value="">ì „ì²´</option>
                <option value="apt" {% if filters.property_type == 'apt' %}selected{% endif %}>ì•„íŒŒíŠ¸</option>
                <option value="villa" {% if filters.property_type == 'villa' %}selected{% endif %}>ì—°ë¦½ë‹¤ì„¸ëŒ€</option>
                <option value="officetel" {% if filters.property_type == 'officetel' %}selected{% endif %}>ì˜¤í”¼ìŠ¤í…”</option>
            </select>
        </div>
        <div>
            <label>ì „ì„¸ìœ í˜•:</label>
            <select name="rent_type">
                <option value="">ì „ì²´</option>
                <option value="jeonse" {% if filters.rent_type == 'jeonse' %}selected{% endif %}>ì „ì„¸</option>
                <option value="monthly" {% if filters.rent_type == 'monthly' %}selected{% endif %}>ì›”ì„¸</option>
            </select>
        </div>
        <div>
            <label>ì†ŒìŠ¤:</label>
            <select name="source">
                <option value="zigbang" {% if filters.source == 'zigbang' %}selected{% endif %}>ì§ë°©</option>
            </select>
        </div>
        <button type="submit" class="primary">ê²€ìƒ‰</button>
    </form>

    {% if listings %}
        <div class="results-header">
            <p>ì´ {{ listings | length }}ê±´ì˜ ë§¤ë¬¼ì´ ê²€ìƒ‰ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
        </div>

        <div class="listings-grid">
            {% for listing in listings %}
            <div class="listing-card">
                <div class="listing-header">
                    <h3>{{ listing.apt_name }}</h3>
                    <div class="listing-meta">
                        <span class="badge">{{ listing.rent_type }}</span>
                        <span class="badge">{{ listing.source }}</span>
                        <span class="location">{{ listing.dong }}</span>
                    </div>
                    <button class="favorite-btn" data-id="{{ listing.id }}">â¤ï¸</button>
                </div>
                <div class="listing-details">
                    <div class="detail-row">
                        <span>ë³´ì¦ê¸ˆ:</span>
                        <span class="price">{{ "{:,}".format(listing.deposit) }}ë§Œì›</span>
                    </div>
                    {% if listing.monthly_rent > 0 %}
                    <div class="detail-row">
                        <span>ì›”ì„¸:</span>
                        <span class="price">{{ "{:,}".format(listing.monthly_rent) }}ë§Œì›</span>
                    </div>
                    {% endif %}
                    <div class="detail-row">
                        <span>ë©´ì :</span>
                        <span class="value">{{ listing.area_m2 }}ã¡</span>
                    </div>
                    <div class="detail-row">
                        <span>ì¸µ:</span>
                        <span class="value">{{ listing.floor }}ì¸µ</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="pagination">
            <a href="?page=1">ì²˜ìŒ</a>
        </div>
    {% else %}
        {% if crawl_status == 'enqueued' %}
        <div class="alert alert-success">
            í¬ë¡¤ë§ ì‘ì—…ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.
        </div>
        {% elif crawl_status == 'duplicate' %}
        <div class="alert alert-warning">
            ì´ë¯¸ í¬ë¡¤ë§ ì‘ì—…ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.
        </div>
        {% endif %}

        <div class="no-results">
            <div class="no-results-icon">ğŸ”</div>
            <p class="no-results-text">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            <p class="no-results-hint">ì•„ì§ ë§¤ë¬¼ ë°ì´í„°ê°€ ìˆ˜ì§‘ë˜ì§€ ì•Šì•˜ê±°ë‚˜, ê²€ìƒ‰ ì¡°ê±´ì— ë§ëŠ” ë§¤ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            <form action="/web/crawl-listings" method="post" class="no-results-actions">
                <input type="hidden" name="source" value="zigbang">
                <button type="submit" class="primary">ë§¤ë¬¼ ìˆ˜ì§‘ ì‹œì‘</button>
            </form>
        </div>
    {% endif %}

    <script>
        // Favorite toggle
        document.querySelectorAll('.favorite-btn').forEach(function(btn) {
            btn.addEventListener('click', async function(e) {
                e.preventDefault();
                const id = this.dataset.id;
                const isActive = this.classList.contains('active');

                try {
                    const response = await fetch(`/web/favorites/${id}`, {
                        method: 'POST',
                    });

                    if (response.ok) {
                        this.classList.toggle('active');
                        const msg = isActive ? 'ì¦ê²€ ëª©ë¡ì—ì„œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì¦ê²€ ëª©ë¡ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.';
                        alert(msg);
                    }
                } catch (err) {
                    console.error('Favorite toggle failed:', err);
                    alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            });
        });
    </script>
{% endblock %}
