{% extends "base.html" %}

{% block title %}QA ì½˜ì†” - Rent Radar{% endblock %}

{% block content %}
<div class="container">
    <h1>ğŸ§ª QA ì½˜ì†”</h1>
    <p>ë°°í¬ ì „ ì ê²€: ìë™ í…ŒìŠ¤íŠ¸ + ìˆ˜ë™ ì´ìƒì¹˜ ì ê²€ + MCP smoke ì‹¤í–‰</p>

    {% if deployment_ready %}
    <div class="alert alert-success">
        ë°°í¬ ì¤€ë¹„ ìƒíƒœ: blocker 0ê±´ (warning {{ warning_count }}ê±´)
    </div>
    {% else %}
    <div class="alert alert-warning">
        ë°°í¬ ì¤€ë¹„ ë¯¸ì™„ë£Œ: blocker {{ blocker_count }}ê±´, warning {{ warning_count }}ê±´
    </div>
    {% endif %}

    <section class="section">
        <h2>ìˆ˜ë™ ì‹¤í–‰</h2>
        <div class="summary-cards">
            <div class="card">
                <h3>ê³µê³µë°ì´í„° Crawl</h3>
                <form action="/web/crawl" method="post">
                    <label for="region_code">ì§€ì—­ ì½”ë“œ</label>
                    <select id="region_code" name="region_code">
                        {% for sido, districts in sido_sigungu.items() %}
                            <optgroup label="{{ sido }}">
                                {% for code, name in districts %}
                                    <option value="{{ code }}" {% if code == '11110' %}selected{% endif %}>{{ name }}</option>
                                {% endfor %}
                            </optgroup>
                        {% endfor %}
                    </select>

                    <label for="property_type">ë§¤ë¬¼ìœ í˜•</label>
                    <select id="property_type" name="property_type">
                        <option value="apt" selected>ì•„íŒŒíŠ¸</option>
                        <option value="villa">ì—°ë¦½ë‹¤ì„¸ëŒ€</option>
                        <option value="officetel">ì˜¤í”¼ìŠ¤í…”</option>
                    </select>

                    <label for="start_year_month">ì‹œì‘ YYYYMM (ì„ íƒ)</label>
                    <input id="start_year_month" name="start_year_month" placeholder="202501" value="">

                    <label for="end_year_month">ì¢…ë£Œ YYYYMM (ì„ íƒ)</label>
                    <input id="end_year_month" name="end_year_month" placeholder="202503" value="">

                    <label>
                        <input type="checkbox" name="force" value="true">
                        dedup ìš°íšŒ(force)
                    </label>
                    <button type="submit">ê³µê³µë°ì´í„° ìˆ˜ì§‘ ì‹¤í–‰</button>
                </form>
            </div>

            <div class="card">
                <h3>ë§¤ë¬¼ Crawl</h3>
                <form action="/web/crawl-listings" method="post">
                    <label for="source">ì†ŒìŠ¤</label>
                    <select id="source" name="source">
                        <option value="all" selected>ì „ì²´</option>
                        <option value="naver">ë„¤ì´ë²„</option>
                        <option value="zigbang">ì§ë°©</option>
                    </select>

                    <label>
                        <input type="checkbox" name="force" value="true">
                        dedup ìš°íšŒ(force)
                    </label>
                    <button type="submit">ë§¤ë¬¼ ìˆ˜ì§‘ ì‹¤í–‰</button>
                </form>
            </div>
        </div>
    </section>

    <section class="section">
        <h2>ìµœê·¼ 24ì‹œê°„ ìˆ˜ì§‘ ìŠ¤ëƒ…ìƒ·</h2>
        <div class="summary-cards">
            {% for snapshot in snapshots %}
            <div class="card">
                <h3>{{ snapshot.source }} ({{ snapshot.table_name }})</h3>
                <div class="value">{{ "{:,}".format(snapshot.last_24h_count) }}</div>
                <p>ìµœê·¼ 24ì‹œê°„ ìˆ˜ì§‘</p>
                <p>ì „ì²´ ëˆ„ì : {{ "{:,}".format(snapshot.total_count) }}</p>
                <p>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: {{ snapshot.last_updated or '-' }}</p>
            </div>
            {% endfor %}
        </div>
    </section>

    <section class="section">
        <h2>ë°ì´í„° í’ˆì§ˆ ì´ìŠˆ (ìƒìœ„ 20ê±´)</h2>
        {% if issues %}
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Table</th>
                    <th>Severity</th>
                    <th>Issue</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                {% for issue in issues[:20] %}
                <tr>
                    <td>{{ issue.id }}</td>
                    <td>{{ issue.table_name }}</td>
                    <td>
                        {% if issue.severity == 'blocker' %}
                        <strong style="color:#b91c1c;">blocker</strong>
                        {% else %}
                        <span style="color:#92400e;">warning</span>
                        {% endif %}
                    </td>
                    <td>{{ issue.issue_type }}</td>
                    <td>{{ issue.description }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>í˜„ì¬ ê°ì§€ëœ í’ˆì§ˆ ì´ìŠˆê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endif %}
    </section>
</div>
{% endblock %}
